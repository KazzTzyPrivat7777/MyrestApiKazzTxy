<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>System Updater</title>
    <link rel="icon" href="/favicon.jpg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --bg-main: #0f0f13;
            --bg-card: #181820;
            --bg-input: #0a0a0e;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --border-color: #27272a;
            --accent-color: #db2777;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-secondary);
            font-family: sans-serif;
        }

        .native-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        }

        .btn-action {
            background-color: var(--accent-color);
            color: white;
            font-weight: bold;
            border-radius: 0.75rem;
            transition: all 0.2s;
        }

        .btn-action:hover { opacity: 0.9; }
        .btn-action:active { transform: scale(0.98); }

        .step-line {
            position: absolute;
            top: 15px;
            left: 0;
            width: 100%;
            height: 2px;
            background: #27272a;
            z-index: 0;
        }

        .step-item {
            position: relative;
            z-index: 1;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #27272a;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            color: #71717a;
            transition: all 0.3s;
        }

        .step-item.active {
            background: var(--accent-color);
            color: white;
            box-shadow: 0 0 15px rgba(219, 39, 119, 0.5);
        }
    </style>
</head>

<body class="min-h-screen p-4 pb-20">
    <div class="max-w-2xl mx-auto space-y-6">

        <!-- Header -->
        <div class="text-center py-6">
            <div class="w-14 h-14 bg-gradient-to-br from-purple-600 to-pink-600 rounded-2xl mx-auto flex items-center justify-center text-2xl text-white shadow-lg mb-4">
                <i class="fas fa-bolt"></i>
            </div>
            <h1 class="text-2xl font-bold text-white">Fast Update</h1>
            <p class="text-sm text-gray-500 mt-1">AI-Powered Code Implementation</p>
        </div>

        <!-- Progress -->
        <div class="relative flex justify-between px-12 mb-8">
            <div class="step-line"></div>
            <div class="step-item active">1</div>
            <div class="step-item" id="step2">2</div>
            <div class="step-item" id="step3">3</div>
        </div>

        <!-- Step 1 -->
        <div class="native-card p-6 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
            <h2 class="text-lg font-bold text-white mb-2 flex items-center gap-2">
                <i class="fas fa-download text-blue-500"></i> Context Extraction
            </h2>
            <p class="text-sm text-gray-400 mb-4 leading-relaxed">Download the latest source code to give full context to the AI.</p>

            <a href="/download" download="context.txt" class="block w-full bg-gray-800 hover:bg-gray-700 text-white text-center font-bold py-3 rounded-xl border border-gray-700 transition-colors">
                Download Context
            </a>
        </div>

        <!-- Step 2 -->
        <div class="native-card p-6 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-1 h-full bg-purple-500"></div>
            <h2 class="text-lg font-bold text-white mb-2 flex items-center gap-2">
                <i class="fas fa-magic text-purple-500"></i> Prompt Generation
            </h2>

            <textarea id="changeRequest" class="w-full bg-black/30 border border-[#27272a] rounded-xl p-3 text-white text-sm mb-3 focus:outline-none focus:border-purple-500 transition-colors" rows="3" placeholder="Describe your changes..."></textarea>

            <button onclick="generatePrompt()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-xl mb-4 transition-transform active:scale-95">
                Generate Prompt
            </button>

            <div class="relative">
                <textarea id="generatedPrompt" class="w-full bg-black text-gray-400 font-mono text-xs rounded-xl p-3 border border-gray-800" rows="4" readonly placeholder="Prompt will appear here..."></textarea>
                <button onclick="copyPrompt()" class="absolute top-2 right-2 text-xs bg-gray-700 text-white px-2 py-1 rounded hover:bg-gray-600">Copy</button>
            </div>
        </div>

        <!-- Step 3 -->
        <div class="native-card p-6 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-1 h-full bg-pink-500"></div>
            <h2 class="text-lg font-bold text-white mb-2 flex items-center gap-2">
                <i class="fas fa-code-branch text-pink-500"></i> Apply Changes
            </h2>

            <textarea id="aiResponse" class="w-full bg-black/30 border border-[#27272a] rounded-xl p-3 text-white font-mono text-xs mb-4 focus:outline-none focus:border-pink-500 transition-colors" rows="6" placeholder="Paste AI response here..."></textarea>

            <button id="applyBtn" onclick="applyUpdate()" class="btn-action w-full py-4 text-lg shadow-lg shadow-pink-900/20 flex items-center justify-center gap-2">
                <i class="fas fa-check-circle"></i> Apply & Restart
            </button>
        </div>

        <div id="status" class="hidden p-4 rounded-xl text-sm font-mono border"></div>
    </div>

    <script>
        const reqInput = document.getElementById('changeRequest');
        const respInput = document.getElementById('aiResponse');

        reqInput.addEventListener('input', () => document.getElementById('step2').classList.add('active'));
        respInput.addEventListener('input', () => document.getElementById('step3').classList.add('active'));

        /* -----------------------------------------
           UPDATED PROMPT GENERATOR (WITH DELETE RULES)
        ------------------------------------------ */
        function generatePrompt() {
            const request = reqInput.value;
            if (!request) return alert('Please describe changes first.');

            const template = `Based on the provided source code, I want you to apply the following changes: "${request}"

IMPORTANT â€” FOLLOW THESE RULES EXACTLY:

1. Your response must ONLY contain code blocks for each file using this exact format:
\`\`\`js
// @path path/to/file.ext
// @type write

// Full file content here...
\`\`\`

2. For deleting a file, you MUST follow this exact format:
\`\`\`js
// @path path/to/file.ext
// @type delete
\`\`\`
- No file content.
- No comments.
- No explanations.
- No text before or after the code block.

3. Do NOT include:
- Explanations
- Introductions
- Reasoning
- Notes
- Warnings
- Markdown headings
- Any text outside code blocks

4. Only output modified or deleted files. Nothing else.

Your output must be clean, minimal, and follow the required format exactly.`;

            document.getElementById('generatedPrompt').value = template;
            document.getElementById('step2').classList.add('active');
        }

        function copyPrompt() {
            const el = document.getElementById('generatedPrompt');
            el.select();
            document.execCommand('copy');
            alert('Copied to clipboard!');
        }

        function utf8ToBase64(str) {
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode(parseInt(p1, 16))));
        }

        async function applyUpdate() {
            const raw = document.getElementById('aiResponse').value;
            const btn = document.getElementById('applyBtn');
            const status = document.getElementById('status');

            if (!raw) return alert('Paste AI response first.');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

            try {
                const encoded = utf8ToBase64(raw);
                const res = await fetch('/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: encoded
                });

                const txt = await res.text();
                status.classList.remove('hidden', 'bg-red-900/20', 'border-red-800', 'text-red-400', 'bg-green-900/20', 'border-green-800', 'text-green-400');

                if (res.ok) {
                    status.classList.add('bg-green-900/20', 'border-green-800', 'text-green-400');
                    status.innerHTML = `<strong>Success!</strong><br><pre class="mt-2 whitespace-pre-wrap">${txt}</pre>`;
                    btn.innerHTML = 'System Restarting...';
                    setTimeout(() => location.reload(), 5000);
                } else {
                    throw new Error(txt);
                }
            } catch (e) {
                status.classList.add('bg-red-900/20', 'border-red-800', 'text-red-400');
                status.textContent = `Error: ${e.message}`;
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check-circle"></i> Retry Apply';
            }
        }
    </script>
</body>
</html>
